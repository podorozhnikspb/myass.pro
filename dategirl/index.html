<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Subscriptions</title>
</head>
<body>
    <h1>Push Notifications</h1>
    <button id="subscribe-button">Подписаться на уведомления</button>
    <div id="error" style="color: red; display: none;"></div>

    <!-- Подключение ps.js -->
    <script type="application/javascript" src="https://lobpc.ext-jscdn.com/ps/ps.js?id=HnFv7gIgUEyhZsQd8kp20Q&sub_id=test_campaign" async></script>

    <script>
        // Регистрация Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/HnFv7gIgUEyhZsQd8kp20Q.js')
                .then(registration => {
                    console.log('Service Worker зарегистрирован:', registration);
                })
                .catch(err => {
                    console.error('Ошибка регистрации Service Worker:', err);
                    document.getElementById('error').innerText = 'Ошибка Service Worker: ' + err;
                    document.getElementById('error').style.display = 'block';
                });
        } else {
            console.warn('Service Worker не поддерживается');
            document.getElementById('error').innerText = 'Service Worker не поддерживается вашим браузером';
            document.getElementById('error').style.display = 'block';
        }

        // Функция для логирования подписки
        function logSubscription(permission, subId = 'test_campaign') {
            const data = {
                id: 'HnFv7gIgUEyhZsQd8kp20Q',
                sub_id: subId,
                permission: permission,
                timestamp: new Date().toISOString()
            };
            fetch('https://your-server.com/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => console.log('Лог подписки отправлен:', response))
            .catch(err => console.error('Ошибка отправки лога:', err));
        }

        // Функция для запроса подписки
        function requestSubscription() {
            const errorDiv = document.getElementById('error');

            // Проверяем статус уведомлений
            if ('Notification' in window && (Notification.permission === 'granted' || Notification.permission === 'denied')) {
                console.log('Уведомления уже разрешены или заблокированы:', Notification.permission);
                logSubscription(Notification.permission);
                errorDiv.innerText = 'Уведомления уже настроены: ' + Notification.permission;
                errorDiv.style.display = 'block';
                return;
            }

            // Проверяем наличие API ps.js
            if (window.ps && typeof window.ps.showPrompt === 'function') {
                console.log('Вызываем подписку через ps.js');
                const timeout = setTimeout(() => {
                    console.log('Тайм-аут: ps.js не вернул результат');
                    errorDiv.innerText = 'Тайм-аут запроса подписки';
                    errorDiv.style.display = 'block';
                }, 5000);

                try {
                    window.ps.showPrompt()
                        .then(result => {
                            clearTimeout(timeout);
                            console.log('Результат подписки:', result);
                            logSubscription(Notification.permission);
                            errorDiv.innerText = 'Подписка успешна!';
                            errorDiv.style.display = 'block';
                        })
                        .catch(err => {
                            clearTimeout(timeout);
                            console.error('Ошибка вызова подписки:', err);
                            logSubscription(Notification.permission);
                            errorDiv.innerText = 'Ошибка подписки: ' + err;
                            errorDiv.style.display = 'block';
                        })
                        .finally(() => {
                            if ('Notification' in window && (Notification.permission === 'granted' || Notification.permission === 'denied')) {
                                clearTimeout(timeout);
                                console.log('Статус уведомлений:', Notification.permission);
                                logSubscription(Notification.permission);
                            }
                        });
                } catch (err) {
                    clearTimeout(timeout);
                    console.error('Синхронная ошибка в ps.js:', err);
                    logSubscription('error');
                    errorDiv.innerText = 'Ошибка ps.js: ' + err;
                    errorDiv.style.display = 'block';
                }
            } else {
                console.log('API ps.js не доступен, используем Notification API');
                if ('Notification' in window) {
                    Notification.requestPermission()
                        .then(permission => {
                            console.log('Результат разрешения:', permission);
                            logSubscription(permission);
                            errorDiv.innerText = 'Статус подписки: ' + permission;
                            errorDiv.style.display = 'block';
                        })
                        .catch(err => {
                            console.error('Ошибка Notification API:', err);
                            logSubscription('error');
                            errorDiv.innerText = 'Ошибка Notification API: ' + err;
                            errorDiv.style.display = 'block';
                        });
                } else {
                    console.log('Уведомления не поддерживаются');
                    logSubscription('unsupported');
                    errorDiv.innerText = 'Уведомления не поддерживаются вашим браузером';
                    errorDiv.style.display = 'block';
                }
            }
        }

        // Событие на клик по кнопке
        document.getElementById('subscribe-button').addEventListener('click', requestSubscription);
    </script>
</body>
</html>